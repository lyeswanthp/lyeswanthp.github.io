document.addEventListener('DOMContentLoaded', function() {
    
    // Core Initialization
    initMobileNavigation();
    initScrollAnimations();
    initSmoothScrolling();
    initHeaderEffects();
    initBackToTop();
    initTypingEffect();
    setCurrentYear();
    initNavigationActiveState();
    
    // --- Navigation and Menu ---
    function initMobileNavigation() {
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const nav = document.getElementById('nav');
        const navLinks = document.querySelectorAll('nav a');
        const backdrop = document.getElementById('mobile-menu-backdrop');
        
        function closeMobileMenu() {
            mobileMenuToggle?.classList.remove('active');
            nav?.classList.remove('active');
            backdrop?.classList.remove('active');
            document.body.classList.remove('menu-open');
        }
        
        function toggleMobileMenu() { 
            const isActive = mobileMenuToggle?.classList.contains('active');
            if (isActive) {
                closeMobileMenu();
            } else {
                mobileMenuToggle?.classList.add('active');
                nav?.classList.add('active');
                backdrop?.classList.add('active');
                document.body.classList.add('menu-open');
            }
        }
        
        mobileMenuToggle?.addEventListener('click', toggleMobileMenu);
        backdrop?.addEventListener('click', closeMobileMenu);
        navLinks.forEach(link => {
            // Close menu on click, but only for anchor links
            if (link.getAttribute('href')?.startsWith('#')) {
                link.addEventListener('click', closeMobileMenu);
            }
        });
        
        window.addEventListener('resize', () => {
            if (window.innerWidth > 640) {
                closeMobileMenu();
            }
        });
    }
    
    // --- Scroll & Animation ---
    function initScrollAnimations() {
        const observerOptions = {
            root: null,
            rootMargin: '0px 0px -50px 0px',
            threshold: 0.05
        };
        
        const observer = new IntersectionObserver((entries, obs) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0) scale(1)';
                    obs.unobserve(entry.target);
                }
            });
        }, observerOptions);
        
        // Target all major containers for a subtle fade/lift entrance
        document.querySelectorAll('section, .project-card, .stats-panel, .timeline-item, .skill-group').forEach(element => {
            element.style.opacity = '0';
            element.style.transform = 'translateY(20px) scale(0.98)';
            element.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
            observer.observe(element);
        });
    }
    
    function initSmoothScrolling() {
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                if (targetId === '#') return;
                
                const targetElement = document.querySelector(targetId);
                if (targetElement) {
                    const headerOffset = window.innerWidth <= 640 ? 70 : 80;
                    const elementPosition = targetElement.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                    
                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                }
            });
        });
    }

    function initHeaderEffects() {
        let lastScrollY = window.scrollY;
        const header = document.querySelector('header');
        
        function updateHeader() {
            const currentScrollY = window.scrollY;
            
            if (currentScrollY > 100) {
                header.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.1)';
                
                // Hide header on scroll down, show on scroll up (for non-mobile view)
                if (currentScrollY > lastScrollY && window.innerWidth > 640) {
                    header.style.transform = 'translateY(-100%)';
                } else {
                    header.style.transform = 'translateY(0)';
                }
            } else {
                header.style.boxShadow = 'none';
                header.style.transform = 'translateY(0)';
            }
            lastScrollY = currentScrollY;
        }
        
        window.addEventListener('scroll', updateHeader);
    }

    function initBackToTop() {
        const backToTopButton = document.querySelector('.back-to-top');
        
        function toggleBackToTopButton() {
            if (window.scrollY > 400) {
                backToTopButton?.classList.add('visible');
            } else {
                backToTopButton?.classList.remove('visible');
            }
        }
        
        window.addEventListener('scroll', toggleBackToTopButton);
        backToTopButton?.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }
    
    // --- Dynamic Content ---
    function initTypingEffect() {
        const roleText = document.querySelector('.role-text');
        if (!roleText) return;
        
        const roles = [
            'Deep Learning systems',
            'MLOps architectures',
            'AI-powered RAG solutions'
        ];
        
        let currentRoleIndex = 0;
        let currentCharIndex = 0;
        let isDeleting = false;
        
        function typeRole() {
            const currentRole = roles[currentRoleIndex];
            
            if (isDeleting) {
                roleText.textContent = currentRole.substring(0, currentCharIndex - 1);
                currentCharIndex--;
            } else {
                roleText.textContent = currentRole.substring(0, currentCharIndex + 1);
                currentCharIndex++;
            }
            
            let typeSpeed = isDeleting ? 75 : 125;
            
            if (!isDeleting && currentCharIndex === currentRole.length) {
                typeSpeed = 2000;
                isDeleting = true;
            } else if (isDeleting && currentCharIndex === 0) {
                isDeleting = false;
                currentRoleIndex = (currentRoleIndex + 1) % roles.length;
                typeSpeed = 500;
            }
            
            setTimeout(typeRole, typeSpeed);
        }
        
        setTimeout(typeRole, 1000); 
    }

    function setCurrentYear() {
        const yearElement = document.getElementById('current-year');
        if (yearElement) {
            yearElement.textContent = new Date().getFullYear();
        }
    }
    
    function initNavigationActiveState() {
        const sections = document.querySelectorAll('section[id]');
        const navLinks = document.querySelectorAll('nav a[href^="#"]');

        function updateActiveNavigation() {
            const scrollPosition = window.scrollY + 100;

            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                const sectionHeight = section.offsetHeight;
                const sectionId = section.getAttribute('id');
                
                if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
                    navLinks.forEach(link => link.classList.remove('active'));
                    const activeLink = document.querySelector(`nav a[href="#${sectionId}"]`);
                    if (activeLink) {
                        activeLink.classList.add('active');
                    }
                }
            });
        }
        
        window.addEventListener('scroll', updateActiveNavigation);
        updateActiveNavigation();
    }
});